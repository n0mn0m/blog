<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.css"
    rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
  <link href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;site.css' rel="stylesheet" />

  
  

  <title>
     burningdaylight | Cleaning Airflow Logs 
  </title>

  <script crossorigin="anonymous" src="https://kit.fontawesome.com/201b8d5e05.js"></script>

  
</head>

<body class="has-background-white">
  
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item has-text-weight-bold" href="/">burningdaylight</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;'>
            Home
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts'>
            Posts
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;docs'>
            Docs
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;git.burningdaylight.io'>
            Repos
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;youtrack.burningdaylight.io&#x2F;projects'>
            Projects
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;teamcity.burningdaylight.io&#x2F;overview.html?guest=1'>
            Builds
          </a>
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>
  

  
  

  
<section class="section pb-0">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article>
          <h1 class="title">Cleaning Airflow Logs</h1>
          <h2 class="subtitle"></h2>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="fas fa-user"></i>
    </span>
     published on
    <span class="icon">
      <i class="far fa-calendar-alt"></i>
    </span>
    <time datetime='2019-12-01'>December 01, 2019</time>
  </p>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="far fa-clock"></i>
    </span>
    2 min,
    <span class="icon">
      <i class="fas fa-pencil-alt"></i>
    </span>
    338 words
  </p>

            </div>
            <div class="column is-4">
              
            </div>
            <div class="column is-8 has-text-right-desktop">
               
  <p>
    <span class="has-text-black has-text-weight-normal">Tags:</span>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;python&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        python
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;airflow&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        airflow
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;logs&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        logs
      </a>
    
  </p>
 
            </div>
          </div>
          <div class="content has-text-justified">
            <p>At home and work I make use of Airflow to automate various batch/time based
task. I've even setup a container based Airflow
<a href="https://git.burningdaylight.io/airflow-docker">environment</a> to make it easy to
bring this up and down.</p>
<p>One of the things you quickly find with Airflow is that while it doesn't need
a lot of  resources to run, it can quickly eat up whatever disk space you
provide it with logs. When this happens the first knobs to look at turning are
your log level and your schedulers dag bag refresh rate. While you may not be
refreshing dags often your may want to keep your log level low to capture more
data and use your log store to put a TTL on things at the <code>INFO</code> level.
Unfortunately you can't completely turn off Airflows disk logging without
building in some custom functionality today. To help manage this I wrote a
small Python script that handles cleaning up the local logs on a given interval.
Note if you're running Airflow in a setup other than <code>LocalExecutor</code> you will
want to handle this with something like Cron instead of a dag since you need
to clean logs up on the Scheduler, Worker and Webserver.</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#cd74e8;">def </span><span style="color:#5cb3fa;">truncate_process_manager_log</span><span style="color:#abb2bf;">(</span><span style="color:#eb6772;">log_base_path</span><span style="color:#abb2bf;">):
    </span><span style="font-style:italic;color:#5f697a;">&quot;&quot;&quot;
    The scheduler records all acitivty related to dag processing in the same file.
    This file can grow large fast, and is actively in use. Intead of unlinking the
    file and pulling it out from under the scheduler truncate.
    &quot;&quot;&quot;
    </span><span style="color:#abb2bf;">dag_process_manager_log </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">os.path.</span><span style="color:#eb6772;">join</span><span style="color:#abb2bf;">(
        log_base_path, </span><span style="color:#9acc76;">&quot;dag_processor_manager&quot;</span><span style="color:#abb2bf;">, </span><span style="color:#9acc76;">&quot;dag_processor_manager.log&quot;
    </span><span style="color:#abb2bf;">)
    </span><span style="color:#5ebfcc;">open</span><span style="color:#abb2bf;">(dag_process_manager_log, </span><span style="color:#9acc76;">&quot;w&quot;</span><span style="color:#abb2bf;">).</span><span style="color:#eb6772;">close</span><span style="color:#abb2bf;">()


</span><span style="color:#cd74e8;">def </span><span style="color:#5cb3fa;">traverse_and_unlink</span><span style="color:#abb2bf;">(</span><span style="color:#eb6772;">fobject</span><span style="color:#abb2bf;">):
    </span><span style="font-style:italic;color:#5f697a;">&quot;&quot;&quot;
    Traverse the log directory on the given airflow instance (webserver, scheduler,
    worker, etc) and remove any logs not modified in the last hour.
    &quot;&quot;&quot;
    </span><span style="color:#cd74e8;">for </span><span style="color:#abb2bf;">entry </span><span style="color:#cd74e8;">in </span><span style="color:#abb2bf;">os.</span><span style="color:#eb6772;">scandir</span><span style="color:#abb2bf;">(fobject):
        new_fobject </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">os.path.</span><span style="color:#eb6772;">join</span><span style="color:#abb2bf;">(fobject, entry)
        </span><span style="color:#cd74e8;">if </span><span style="color:#abb2bf;">os.path.</span><span style="color:#eb6772;">isfile</span><span style="color:#abb2bf;">(new_fobject):
            last_modified </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">os.</span><span style="color:#eb6772;">stat</span><span style="color:#abb2bf;">(new_fobject).st_mtime
            delta </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">datetime.</span><span style="color:#eb6772;">utcnow</span><span style="color:#abb2bf;">().</span><span style="color:#eb6772;">timestamp</span><span style="color:#abb2bf;">() </span><span style="color:#adb7c9;">- </span><span style="color:#abb2bf;">last_modified
            </span><span style="color:#cd74e8;">if </span><span style="color:#abb2bf;">delta </span><span style="color:#adb7c9;">&gt; </span><span style="color:#eb6772;">HOURS_IN_MILLISECONDS</span><span style="color:#abb2bf;">:
                </span><span style="color:#5ebfcc;">print</span><span style="color:#abb2bf;">(
                    </span><span style="color:#cd74e8;">f</span><span style="color:#9acc76;">&quot;</span><span style="color:#abb2bf;">{new_fobject}</span><span style="color:#9acc76;"> has not been used in the last hour. \
</span><span style="color:#5ebfcc;">\n</span><span style="color:#9acc76;">Cleaning up.&quot;
                </span><span style="color:#abb2bf;">)
                os.</span><span style="color:#eb6772;">unlink</span><span style="color:#abb2bf;">(new_fobject)
            </span><span style="color:#cd74e8;">elif </span><span style="color:#abb2bf;">os.path.</span><span style="color:#eb6772;">isdir</span><span style="color:#abb2bf;">(new_fobject):
                </span><span style="color:#eb6772;">traverse_and_unlink</span><span style="color:#abb2bf;">(new_fobject)
</span></code></pre>
<p>The full script is available <a href="https://git.burningdaylight.io/snippets/tree/main/airflow-log-cleanup.py">here</a>.</p>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="field">
        <p class="control has-icons-right">
          <input class="input" id="search" placeholder="Search this website." type="search" />
          <span class="icon is-small is-right">
            <i class="fas fa-search"></i>
          </span>
        </p>
      </div>
      <div class="search-results">
        <div class="search-results__items"></div>
      </div>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


   
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
          
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;parsing-time&#x2F;"
            >
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              Parsing Time with Python
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;edx-ut601-review&#x2F;"
            >
              Review EdX UT601 Embedded Systems<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
            
        </nav>
      </div>
    </div>
  </div>
</section>
 

    

  
  <footer class="py-4 has-background-light">
    <p class="has-text-centered">
      Built with
      <span class="icon is-small">
        <i class="fas fa-code fa-xs"></i>
      </span>
      code and
      <span class="icon is-small">
        <i class="fas fa-heart fa-xs"></i>
      </span>
      love <br /> Powered By
      <span class="icon is-small">
        <i class="fas fa-power-off fa-xs"></i>
      </span>
      Zola <br />Posts licensed by <a href="https://creativecommons.org/publicdomain/zero/1.0/">Creative Commons CC0 1.0 </a><i class="fa fa-cc"></i>
      <br /> Code licensed <a href="https://www.gnu.org/licenses/lgpl-3.0.txt">LGPL</a>
    </p>
  </footer>
  

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sharer.js@latest/sharer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/galleria.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1/dist/chart.xkcd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/elasticlunr/0.9.6/elasticlunr.min.js"></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;search_index.en.js'></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;js&#x2F;site.js'></script>

    
</body>

</html>