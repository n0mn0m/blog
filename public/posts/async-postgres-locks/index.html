<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.css"
    rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
  <link href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;site.css' rel="stylesheet" />

  
  

  <title>
     burningdaylight | Postgres Advisory Locks with Asyncio 
  </title>

  <script crossorigin="anonymous" src="https://kit.fontawesome.com/201b8d5e05.js"></script>

  
</head>

<body class="has-background-white">
  
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item has-text-weight-bold" href="/">burningdaylight</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;'>
            Home
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts'>
            Posts
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;docs'>
            Docs
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;git.burningdaylight.io'>
            Repos
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;youtrack.burningdaylight.io&#x2F;projects'>
            Projects
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;teamcity.burningdaylight.io&#x2F;overview.html?guest=1'>
            Builds
          </a>
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>
  

  
  

  
<section class="section pb-0">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article>
          <h1 class="title">Postgres Advisory Locks with Asyncio</h1>
          <h2 class="subtitle"></h2>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="fas fa-user"></i>
    </span>
     published on
    <span class="icon">
      <i class="far fa-calendar-alt"></i>
    </span>
    <time datetime='2019-08-08'>August 08, 2019</time>
  </p>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="far fa-clock"></i>
    </span>
    4 min,
    <span class="icon">
      <i class="fas fa-pencil-alt"></i>
    </span>
    629 words
  </p>

            </div>
            <div class="column is-4">
              
            </div>
            <div class="column is-8 has-text-right-desktop">
               
  <p>
    <span class="has-text-black has-text-weight-normal">Tags:</span>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;python&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        python
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;asyncio&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        asyncio
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;postgres&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        postgres
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;database&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        database
      </a>
    
  </p>
 
            </div>
          </div>
          <div class="content has-text-justified">
            <p>Recently, here on the Cloud team at Elastic we started working on building a
new service in Python 3.7. This service fetches data from a Postgres database,
transforms it, and then submits that data to another service. Like many
cloud-based services, ours runs in an orchestrated container environment where
N instances can be running at any time. Often that's a good thing, but our
service has a few critical sections where only one instance should be able to
process data. Since we are retrieving data from Postgres, we decided to go
ahead and make use of <code>advisory locks</code> to control these critical sections. In
this article I want to explain what advisory locks are, provide an
implementation, and test to verify functionality.</p>
<h2 id="advisory-locks">Advisory locks</h2>
<p>Postgres provides the ability to create locks that only have meaning within
the context of your application. These are
<a href="https://www.postgresql.org/docs/9.4/explicit-locking.html#ADVISORY-LOCKS">advisory locks</a>.
You use advisory locks to control an applicationâ€™s ability to process data.
Anytime your application is about to enter a critical path, you attempt to
acquire the lock. When you acquire the lock, you can safely continue processing.</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#cd74e8;">async with </span><span style="color:#eb6772;">AdvisoryLock</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&quot;gold_leader&quot;</span><span style="color:#abb2bf;">, dbconfig) </span><span style="color:#cd74e8;">as </span><span style="color:#abb2bf;">connection:
</span></code></pre>
<p>If it fails, then your application may retry, wait, or exit. Since this lock is
external to the application, this allows for multiple instances of the
application to run while providing safe critical path concurrency.</p>
<h2 id="building-the-lock">Building the lock</h2>
<p>As part of our work, we wanted to make using advisory locks easy. To do this,
we created the <code>PostgresAdvisoryLock</code> context manager. Since this is meant to
be used with <code>asyncio</code> and <code>asyncpg</code>, we control the acquisition and release of
the lock via <code>__aenter__</code> and <code>__aexit__</code>.</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#cd74e8;">class </span><span style="color:#f0c678;">AdvisoryLock</span><span style="color:#adb7c9;">:
    </span><span style="color:#cd74e8;">async def </span><span style="color:#5ebfcc;">__aenter__</span><span style="color:#abb2bf;">(</span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">) -&gt; asyncpg.connection.Connection:
        </span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">.locked_connection </span><span style="color:#adb7c9;">= </span><span style="color:#cd74e8;">await </span><span style="color:#abb2bf;">asyncpg.</span><span style="color:#eb6772;">connect</span><span style="color:#abb2bf;">(</span><span style="color:#db9d63;">...</span><span style="color:#abb2bf;">)
        </span><span style="color:#cd74e8;">await </span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">.</span><span style="color:#eb6772;">_set_lock</span><span style="color:#abb2bf;">()
        </span><span style="color:#cd74e8;">if </span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">.got_lock:
            </span><span style="color:#cd74e8;">return </span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">.locked_connection
        </span><span style="color:#cd74e8;">else</span><span style="color:#abb2bf;">:
            </span><span style="color:#cd74e8;">if </span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">.locked_connection:
                </span><span style="color:#cd74e8;">await </span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">.locked_connection.</span><span style="color:#eb6772;">close</span><span style="color:#abb2bf;">()
            </span><span style="color:#cd74e8;">raise </span><span style="color:#abb2bf;">AdvisoryLockException

    </span><span style="color:#cd74e8;">async def </span><span style="color:#5ebfcc;">__aexit__</span><span style="color:#abb2bf;">(</span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">, </span><span style="color:#eb6772;">exc_type</span><span style="color:#abb2bf;">, </span><span style="color:#eb6772;">exc_val</span><span style="color:#abb2bf;">, </span><span style="color:#eb6772;">exc_tb</span><span style="color:#abb2bf;">):
        </span><span style="color:#cd74e8;">await </span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">.</span><span style="color:#eb6772;">_release</span><span style="color:#abb2bf;">()
</span></code></pre>
<p>Now this can be called like any other async context manager.</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#cd74e8;">async with </span><span style="color:#eb6772;">AdvisoryLock</span><span style="color:#abb2bf;">(config, </span><span style="color:#9acc76;">&quot;appname&quot;</span><span style="color:#abb2bf;">) </span><span style="color:#cd74e8;">as </span><span style="color:#abb2bf;">connection:
    val </span><span style="color:#adb7c9;">= </span><span style="color:#cd74e8;">await </span><span style="color:#abb2bf;">connection.</span><span style="color:#eb6772;">fetchrow</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&quot;</span><span style="color:#cd74e8;">SELECT </span><span style="color:#db9d63;">1</span><span style="color:#9acc76;">&quot;</span><span style="color:#abb2bf;">)
</span></code></pre><h2 id="testing-the-lock">Testing the lock</h2>
<p>Now that the <code>PostgresAdvisoryLock</code> class is implemented, we need to test it.
To start we verify the base functionality by acquiring the lock, running a
query, and validating we can't get the lock inside the same scope. I recommend
using the <code>asynctest</code> library to help work with <code>asyncio</code> inside <code>unittest</code>.</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#abb2bf;">    </span><span style="color:#cd74e8;">async def </span><span style="color:#5cb3fa;">test_get_results_with_lock</span><span style="color:#abb2bf;">(</span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">):
        </span><span style="color:#cd74e8;">async with </span><span style="color:#eb6772;">AdvisoryLock</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&quot;gold_leader&quot;</span><span style="color:#abb2bf;">, dbconfig) </span><span style="color:#cd74e8;">as </span><span style="color:#abb2bf;">connection:
            val </span><span style="color:#adb7c9;">= </span><span style="color:#cd74e8;">await </span><span style="color:#abb2bf;">connection.</span><span style="color:#eb6772;">fetchrow</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&quot;</span><span style="color:#cd74e8;">SELECT </span><span style="color:#db9d63;">1</span><span style="color:#abb2bf;">;</span><span style="color:#9acc76;">&quot;</span><span style="color:#abb2bf;">)
            </span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">.</span><span style="color:#eb6772;">assertEqual</span><span style="color:#abb2bf;">(val[</span><span style="color:#db9d63;">0</span><span style="color:#abb2bf;">], </span><span style="color:#db9d63;">1</span><span style="color:#abb2bf;">)

    </span><span style="color:#cd74e8;">async def </span><span style="color:#5cb3fa;">test_lock_prevents_second_lock</span><span style="color:#abb2bf;">(</span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">):
        </span><span style="color:#cd74e8;">with </span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">.</span><span style="color:#eb6772;">assertRaises</span><span style="color:#abb2bf;">(AdvisoryLockException):
            </span><span style="color:#cd74e8;">async with </span><span style="color:#eb6772;">AdvisoryLock</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&quot;gold_leader&quot;</span><span style="color:#abb2bf;">, dbconfig) </span><span style="color:#cd74e8;">as </span><span style="color:#abb2bf;">connection:
                </span><span style="color:#cd74e8;">await </span><span style="color:#abb2bf;">connection.</span><span style="color:#eb6772;">fetchrow</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&quot;</span><span style="color:#cd74e8;">SELECT </span><span style="color:#db9d63;">1</span><span style="color:#abb2bf;">;</span><span style="color:#9acc76;">&quot;</span><span style="color:#abb2bf;">)
                </span><span style="color:#cd74e8;">async with </span><span style="color:#eb6772;">AdvisoryLock</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&quot;gold_leader&quot;</span><span style="color:#abb2bf;">, dbconfig) </span><span style="color:#cd74e8;">as </span><span style="color:#abb2bf;">second_connection:
                    </span><span style="color:#cd74e8;">await </span><span style="color:#abb2bf;">second_connection.</span><span style="color:#eb6772;">fetchrow</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&quot;</span><span style="color:#cd74e8;">SELECT </span><span style="color:#db9d63;">1</span><span style="color:#abb2bf;">;</span><span style="color:#9acc76;">&quot;</span><span style="color:#abb2bf;">)
</span></code></pre>
<p>Since we are going to use this to control the execution of code across many
processes, we also need to verify external process behavior. To do this we use
the <code>asyncio</code>  <code>subprocess.create_subprocess_exec</code> function to create a new
process. This process attempts to get the lock our main process already has,
and it should fail.</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#abb2bf;">    </span><span style="color:#cd74e8;">async def </span><span style="color:#5cb3fa;">test_advisory_lock_prevents_access_from_separate_process</span><span style="color:#abb2bf;">(</span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">):
        </span><span style="color:#cd74e8;">with </span><span style="color:#eb6772;">self</span><span style="color:#abb2bf;">.</span><span style="color:#eb6772;">assertRaises</span><span style="color:#abb2bf;">(AdvisoryLockException):
            </span><span style="color:#cd74e8;">async with </span><span style="color:#eb6772;">AdvisoryLock</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&quot;gold_leader&quot;</span><span style="color:#abb2bf;">, dbconfig) </span><span style="color:#cd74e8;">as </span><span style="color:#abb2bf;">connection:
                proc </span><span style="color:#adb7c9;">= </span><span style="color:#cd74e8;">await </span><span style="color:#abb2bf;">asyncio.subprocess.</span><span style="color:#eb6772;">create_subprocess_exec</span><span style="color:#abb2bf;">(
                    sys.executable,
                    </span><span style="color:#9acc76;">&quot;-c&quot;</span><span style="color:#abb2bf;">,
                    executable,
                    </span><span style="color:#eb6772;">stderr</span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;">asyncio.subprocess.</span><span style="color:#eb6772;">PIPE</span><span style="color:#abb2bf;">,
                )
</span></code></pre><h3 id="wrapping-up">Wrapping up</h3>
<p>When we started to build our new application, we knew we would be waiting on
the network and database. Since we also had work that could happen during the
wait, we decided to use <code>asyncio</code>. Additionally we identified a critical path
where we used Postgres to achieve concurrency control. To make critical path
control easier we created a module and a series of tests. Once finished we
realized this might be helpful to others looking for the same control, or as
a reference for those learning to test with asyncio.</p>
<p>You can find the full implementation and Docker setup
<a href="https://git.burningdaylight.io/PostgresAdvisoryLock">on Sourcehut</a>.</p>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="field">
        <p class="control has-icons-right">
          <input class="input" id="search" placeholder="Search this website." type="search" />
          <span class="icon is-small is-right">
            <i class="fas fa-search"></i>
          </span>
        </p>
      </div>
      <div class="search-results">
        <div class="search-results__items"></div>
      </div>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


   
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
          
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;hackaday-connected-world&#x2F;"
            >
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
               Hackaday Connected World Follow Up
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;connected-roomba-wrap-up&#x2F;"
            >
              Connected Roomba - Wrapping Up<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
            
        </nav>
      </div>
    </div>
  </div>
</section>
 

    

  
  <footer class="py-4 has-background-light">
    <p class="has-text-centered">
      Built with
      <span class="icon is-small">
        <i class="fas fa-code fa-xs"></i>
      </span>
      code and
      <span class="icon is-small">
        <i class="fas fa-heart fa-xs"></i>
      </span>
      love <br /> Powered By
      <span class="icon is-small">
        <i class="fas fa-power-off fa-xs"></i>
      </span>
      Zola <br />Posts licensed by <a href="https://creativecommons.org/publicdomain/zero/1.0/">Creative Commons CC0 1.0 </a><i class="fa fa-cc"></i>
      <br /> Code licensed <a href="https://www.gnu.org/licenses/lgpl-3.0.txt">LGPL</a>
    </p>
  </footer>
  

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sharer.js@latest/sharer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/galleria.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1/dist/chart.xkcd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/elasticlunr/0.9.6/elasticlunr.min.js"></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;search_index.en.js'></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;js&#x2F;site.js'></script>

    
</body>

</html>