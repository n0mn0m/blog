<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.css"
    rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
  <link href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;site.css' rel="stylesheet" />

  
  

  <title>
     burningdaylight | Train All the Things - Speed Bumps 
  </title>

  <script crossorigin="anonymous" src="https://kit.fontawesome.com/201b8d5e05.js"></script>

  
</head>

<body class="has-background-white">
  
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item has-text-weight-bold" href="/">burningdaylight</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;'>
            Home
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts'>
            Posts
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;docs'>
            Docs
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;git.burningdaylight.io'>
            Repos
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;youtrack.burningdaylight.io&#x2F;projects'>
            Projects
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;teamcity.burningdaylight.io&#x2F;overview.html?guest=1'>
            Builds
          </a>
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>
  

  
  

  
<section class="section pb-0">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article>
          <h1 class="title">Train All the Things - Speed Bumps</h1>
          <h2 class="subtitle"></h2>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="fas fa-user"></i>
    </span>
     published on
    <span class="icon">
      <i class="far fa-calendar-alt"></i>
    </span>
    <time datetime='2020-03-30'>March 30, 2020</time>
  </p>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="far fa-clock"></i>
    </span>
    6 min,
    <span class="icon">
      <i class="fas fa-pencil-alt"></i>
    </span>
    1069 words
  </p>

            </div>
            <div class="column is-4">
              
            </div>
            <div class="column is-8 has-text-right-desktop">
               
  <p>
    <span class="has-text-black has-text-weight-normal">Tags:</span>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;hackaday&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        hackaday
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;maker&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        maker
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;dependency-management&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        dependency management
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;bugs&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        bugs
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;esp-idf&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        esp-idf
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;esp&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        esp
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;tensorflow&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        tensorflow
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;train-all-the-things&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        train all the things
      </a>
    
  </p>
 
            </div>
          </div>
          <div class="content has-text-justified">
            <p>As part of getting started on my project a couple months back I took a look at
what boards were supported by
<a href="https://www.tensorflow.org/lite/microcontrollers#supported_platforms">Tensorflow lite</a>
. Seeing an esp board I went that route since I've heard alot from the
maker/hacker community and thought it would be a good opportunity to learn more.
Additionally it's been quite a while since I had a project that was primarily
<code>C/C++</code> so that was exciting. Like any good project I ran into multiple
unexpected bumps, bugs and issues. Some were minor, others were frustrating. I'm
capturing some of those here for anybody else that may be starting down the path
of using Tensorflow Lite and an ESP32 board.</p>
<h2 id="tensorflow-speed-bumps">Tensorflow speed bumps</h2>
<p>Getting started with TF Lite is easy enough, but something I noticed as I
continued to work on the project is just how little things are designed specific
to the platform. Instead the examples are setup with Arduino as a default, and
then work is done to make that run on X target. In the case of the <code>ESP-EYE</code>
this looks like packing everything into an Arduino compatible loop, and handling
that in a single FreeRTOS task. I get the reason for this, but it's also a bit
of a headache later on as it feels like an anti pattern when addin in new task
and event handlers.</p>
<p>Another bump you are likely to notice is that the TF Lite examples rely on
functionality present in the TF <code>1.x</code> branch for training, but require TF
<code>&gt;= 2.2</code> for micro libs. Not the end of the world, but it means your going to
manage multiple environts. If managing this using <code>venv</code>/<code>virtualenv</code> keep in
mind you're going to need the <code>esp-idf</code> requirements in the 2.x environment, or
just install in both as you may find yourself switching back and forth. In
addition to python lib versions the examples note <code>esp-idf 4.0</code>, but you will
want to use <code>&gt;=4.0</code> with <a href="https://github.com/espressif/esp-idf/pull/4251">this</a>
commit or you will run into compiler failures. I ended up using <code>4.1</code>
eventually, but something to note.</p>
<p>Finally interaction with the model feels flaky. It's an example so this kind of
makes sense, but I found that while the word detected was pretty accurate the
<code>new_command</code> and some of the attributes of the keyword being provided by the
model weren't matching my expectation/use. I ended up using the <code>score</code> value
and monitoring the model to setup the conditionals for responding to commands in
my application.</p>
<p>Overall the examples are great to have, and walking you through the train, test
and load cycle is really helpful. The main thing I wish I had known was that the
TF Arduino path for ESP was pretty much the same as the ESP native path with
regards to utility and functionality just using the <code>esp-idf</code> toolchain.</p>
<h2 id="esp-speed-bumps">ESP speed bumps</h2>
<p>From the ESP side of things the core <code>idf</code> tooling is nice. I like how open it
is and how much I can understand the different pieces. This helped a few times
when I ran into unexpected behavior. One thing to note is if you follow the
documented path of cloning <code>esp-idf</code> you will want to consider how you manage
the release branch you use and when you merge updates. Updates are not pushed
into minor/bug fix branches instead they go into the release branch targeted on
merge.</p>
<p>Being new to the esp platform something I didn't know when I got started was
that <a href="https://github.com/espressif/esp-idf/releases/tag/v4.0"><code>esp-idf 4.x</code></a>
released in February of 2020. Because of this alot of the documentation and
examples such as <a href="https://github.com/espressif/esp-who"><code>ESP-WHO</code></a> and
<a href="https://github.com/espressif/esp-skainet"><code>esp-skainet</code></a> are still based on
<code>3.x</code> which has a variety of differences and changes in things like
the TCP/network stack. Because of this checking the version used in various
docs, examples etc is (as usual) important. Since the TF examples reference
version 4 that's where I started, but a lot of what's out there is based on v3.</p>
<p>One other bump somebody may run into is struct initialization in a modern
toolchain when calling the underlying esp C libraries from C++. I spent some
time digging around after transitioning the http request example into the TF C++
<code>command_responder</code> code and the compiler told me I was missing uninitialized
struct fields and their order made them required.</p>
<p>The example code:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#abb2bf;">esp_http_client_config_t config </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">{
        .</span><span style="color:#eb6772;">url </span><span style="color:#adb7c9;">= </span><span style="color:#9acc76;">&quot;http://httpbin.org/get&quot;</span><span style="color:#abb2bf;">,
        .</span><span style="color:#eb6772;">event_handler </span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;"> _http_event_handler,
        .</span><span style="color:#eb6772;">user_data </span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;"> local_response_buffer,
};
esp_http_client_handle_t client </span><span style="color:#adb7c9;">= </span><span style="color:#eb6772;">esp_http_client_init</span><span style="color:#abb2bf;">(</span><span style="color:#adb7c9;">&amp;</span><span style="color:#abb2bf;">config);
esp_err_t err </span><span style="color:#adb7c9;">= </span><span style="color:#eb6772;">esp_http_client_perform</span><span style="color:#abb2bf;">(client);
</span></code></pre>
<p>And how I had to do it in C++:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#abb2bf;">esp_http_client_config_t</span><span style="color:#adb7c9;">*</span><span style="color:#abb2bf;"> config </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">(esp_http_client_config_t</span><span style="color:#adb7c9;">*</span><span style="color:#abb2bf;">)</span><span style="color:#5ebfcc;">calloc</span><span style="color:#abb2bf;">(</span><span style="color:#adb7c9;">sizeof</span><span style="color:#abb2bf;">(esp_http_client_config_t), </span><span style="color:#db9d63;">1</span><span style="color:#abb2bf;">);
config-&gt;</span><span style="color:#eb6772;">url </span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;"> URL;
config-&gt;</span><span style="color:#eb6772;">cert_pem </span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;"> burningdaylight_io_root_cert_pem_start;
config-&gt;</span><span style="color:#eb6772;">event_handler </span><span style="color:#adb7c9;">=</span><span style="color:#abb2bf;"> _http_event_handler;

esp_http_client_handle_t client </span><span style="color:#adb7c9;">= </span><span style="color:#eb6772;">esp_http_client_init</span><span style="color:#abb2bf;">(config);
</span><span style="color:#eb6772;">esp_http_client_set_method</span><span style="color:#abb2bf;">(client, HTTP_METHOD_PUT);
esp_err_t err </span><span style="color:#adb7c9;">= </span><span style="color:#eb6772;">esp_http_client_perform</span><span style="color:#abb2bf;">(client);
</span></code></pre>
<p>I had a similar issue with wifi and you can see the solution
<a href="https://git.burningdaylight.io/on-air/tree/main/voice-assistant/smalltalk/main/http/wifi.cc#L40">here</a>.</p>
<p>I really enjoyed my lite trip into <code>idf</code>. It's an interesting set of components
and followed a workflow that I use and appreciate. I wrote a couple aliases
that somebody might find useful:</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#5ebfcc;">alias </span><span style="color:#5cb3fa;">adf</span><span style="color:#adb7c9;">=</span><span style="color:#9acc76;">&quot;export ADF_PATH=$</span><span style="color:#eb6772;">HOME</span><span style="color:#9acc76;">/projects/esp-adf&quot;
</span><span style="color:#5ebfcc;">alias </span><span style="color:#5cb3fa;">idf-refresh</span><span style="color:#adb7c9;">=</span><span style="color:#9acc76;">&quot;rm -rf $</span><span style="color:#eb6772;">HOME</span><span style="color:#9acc76;">/projects/esp-idf &amp;&amp; git clone --recursive git@github.com:espressif/esp-idf.git $</span><span style="color:#eb6772;">HOME</span><span style="color:#9acc76;">/projects/esp-idf &amp;&amp; $</span><span style="color:#eb6772;">HOME</span><span style="color:#9acc76;">/projects/esp-idf/install.sh&quot;
</span><span style="color:#5ebfcc;">alias </span><span style="color:#5cb3fa;">idf</span><span style="color:#adb7c9;">=</span><span style="color:#9acc76;">&quot;. $</span><span style="color:#eb6772;">HOME</span><span style="color:#9acc76;">/projects/esp-idf/export.sh&quot;
</span><span style="color:#5ebfcc;">alias </span><span style="color:#5cb3fa;">idf3</span><span style="color:#adb7c9;">=</span><span style="color:#9acc76;">&quot;pushd $</span><span style="color:#eb6772;">HOME</span><span style="color:#9acc76;">/projects/esp-idf &amp;&amp; git checkout release/v3.3 &amp;&amp; popd &amp;&amp; . $</span><span style="color:#eb6772;">HOME</span><span style="color:#9acc76;">/projects/esp-idf/export.sh&quot;
</span><span style="color:#5ebfcc;">alias </span><span style="color:#5cb3fa;">idf4x</span><span style="color:#adb7c9;">=</span><span style="color:#9acc76;">&quot;pushd $</span><span style="color:#eb6772;">HOME</span><span style="color:#9acc76;">/projects/esp-idf &amp;&amp; git checkout release/v4.0 &amp;&amp; popd &amp;&amp; . $</span><span style="color:#eb6772;">HOME</span><span style="color:#9acc76;">/projects/esp-idf/export.sh&quot;
</span><span style="color:#5ebfcc;">alias </span><span style="color:#5cb3fa;">idf4</span><span style="color:#adb7c9;">=</span><span style="color:#9acc76;">&quot;pushd $</span><span style="color:#eb6772;">HOME</span><span style="color:#9acc76;">/projects/esp-idf &amp;&amp; git checkout release/v4.1 &amp;&amp; popd &amp;&amp; . $</span><span style="color:#eb6772;">HOME</span><span style="color:#9acc76;">/projects/esp-idf/export.sh&quot;
</span><span style="color:#5ebfcc;">alias </span><span style="color:#5cb3fa;">idf-test</span><span style="color:#adb7c9;">=</span><span style="color:#9acc76;">&quot;idf.py --port /dev/cu.SLAB_USBtoUART flash monitor&quot;
</span></code></pre>
<p>And I look forward to writing more about esp as I continue to use it in new
projects.</p>
<p>Approaching the end of this project it's been a larger undertaking than I
expected, but I've learned a lot. It's definitely generated a few new project
ideas. The code, docs, images etc for the project can be found
<a href="https://git.burningdaylight.io/on-air">here</a> and I'll be posting updates as I
continue along to <a href="https://hackaday.io/project/170228-on-air">HackadayIO</a> and
this blog. If you have any questions or ideas reach
<a href="mailto:n0mn0m@burningdaylight.io">out</a>.</p>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="field">
        <p class="control has-icons-right">
          <input class="input" id="search" placeholder="Search this website." type="search" />
          <span class="icon is-small is-right">
            <i class="fas fa-search"></i>
          </span>
        </p>
      </div>
      <div class="search-results">
        <div class="search-results__items"></div>
      </div>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


   
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
          
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;group-by-python&#x2F;"
            >
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              GroupBy Fun with SQL and Python
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;train-all-the-things-finished&#x2F;"
            >
              Train All the Things - Wrapping Up<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
            
        </nav>
      </div>
    </div>
  </div>
</section>
 

    

  
  <footer class="py-4 has-background-light">
    <p class="has-text-centered">
      Built with
      <span class="icon is-small">
        <i class="fas fa-code fa-xs"></i>
      </span>
      code and
      <span class="icon is-small">
        <i class="fas fa-heart fa-xs"></i>
      </span>
      love <br /> Powered By
      <span class="icon is-small">
        <i class="fas fa-power-off fa-xs"></i>
      </span>
      Zola <br />Posts licensed by <a href="https://creativecommons.org/publicdomain/zero/1.0/">Creative Commons CC0 1.0 </a><i class="fa fa-cc"></i>
      <br /> Code licensed <a href="https://www.gnu.org/licenses/lgpl-3.0.txt">LGPL</a>
    </p>
  </footer>
  

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sharer.js@latest/sharer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/galleria.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1/dist/chart.xkcd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/elasticlunr/0.9.6/elasticlunr.min.js"></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;search_index.en.js'></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;js&#x2F;site.js'></script>

    
</body>

</html>