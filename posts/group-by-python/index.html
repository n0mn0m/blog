<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.css"
    rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
  <link href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;site.css' rel="stylesheet" />

  
  

  <title>
     burningdaylight | GroupBy Fun with SQL and Python 
  </title>

  <script crossorigin="anonymous" src="https://kit.fontawesome.com/201b8d5e05.js"></script>

  
</head>

<body class="has-background-white">
  
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item has-text-weight-bold" href="/">burningdaylight</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;'>
            Home
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts'>
            Posts
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;docs'>
            Docs
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;github.com&#x2F;n0mn0m'>
            Repos
          </a>
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>
  

  
  

  
<section class="section pb-0">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article>
          <h1 class="title">GroupBy Fun with SQL and Python</h1>
          <h2 class="subtitle"></h2>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="fas fa-user"></i>
    </span>
     published on
    <span class="icon">
      <i class="far fa-calendar-alt"></i>
    </span>
    <time datetime='2020-05-28'>May 28, 2020</time>
  </p>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="far fa-clock"></i>
    </span>
    6 min,
    <span class="icon">
      <i class="fas fa-pencil-alt"></i>
    </span>
    1090 words
  </p>

            </div>
            <div class="column is-4">
              
            </div>
            <div class="column is-8 has-text-right-desktop">
               
  <p>
    <span class="has-text-black has-text-weight-normal">Tags:</span>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;python&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        python
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;sql&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        sql
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;sets&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        sets
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;itertools&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        itertools
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;spark&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        spark
      </a>
    
  </p>
 
            </div>
          </div>
          <div class="content has-text-justified">
            <p>A few months ago I had the opportunity to collaborate with some Data Scientist
porting PySpark queries to raw Python. One of the primary areas of concern was
aggregation statements. These were seen as functionality that would be
particularly troublesome to write in Python. As an example I was provided a
Spark SQL query similar to this:</p>
<pre style="background-color:#2b303b;">
<code class="language-python" data-lang="python"><span style="color:#abb2bf;">text </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">ocr_data.</span><span style="color:#eb6772;">filter</span><span style="color:#abb2bf;">(</span><span style="color:#eb6772;">col</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39;lvl&#39;</span><span style="color:#abb2bf;">)</span><span style="color:#adb7c9;">==</span><span style="color:#db9d63;">5</span><span style="color:#abb2bf;">).</span><span style="color:#eb6772;">filter</span><span style="color:#abb2bf;">(f.</span><span style="color:#eb6772;">length</span><span style="color:#abb2bf;">(f.</span><span style="color:#eb6772;">trim</span><span style="color:#abb2bf;">(col</span><span style="color:#9acc76;">&#39;txt&#39;</span><span style="color:#abb2bf;">))) </span><span style="color:#adb7c9;">&gt; </span><span style="color:#db9d63;">0</span><span style="background-color:#e05252;color:#ffffff;">)</span><span style="color:#abb2bf;">.</span><span style="color:#eb6772;">select</span><span style="color:#abb2bf;">(txt_cols) \
    .</span><span style="color:#eb6772;">withColumn</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39;c_txt&#39; </span><span style="color:#eb6772;">case_std</span><span style="color:#abb2bf;">(</span><span style="color:#eb6772;">col</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39;txt&#39;</span><span style="color:#abb2bf;">))) \
    .</span><span style="color:#eb6772;">drop</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39;txt&#39;</span><span style="color:#abb2bf;">) \
    .</span><span style="color:#eb6772;">withColumn</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39;tk_pos&#39;</span><span style="color:#abb2bf;">, f.</span><span style="color:#eb6772;">struct</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39;wrd_nm&#39;</span><span style="color:#abb2bf;">, </span><span style="color:#9acc76;">&#39;c_txt&#39;</span><span style="color:#abb2bf;">)) \
    .</span><span style="color:#eb6772;">groupBy</span><span style="color:#abb2bf;">(ln_cols) \
    .</span><span style="color:#eb6772;">agg</span><span style="color:#abb2bf;">(f.</span><span style="color:#eb6772;">sort_array</span><span style="color:#abb2bf;">(f.</span><span style="color:#eb6772;">collect_list</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39;tk_pos&#39;</span><span style="color:#abb2bf;">)).</span><span style="color:#eb6772;">alias</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39;txt_array&#39;</span><span style="color:#abb2bf;">)) \
    .</span><span style="color:#eb6772;">withColum</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39;txt_ln&#39;</span><span style="color:#abb2bf;">, f.</span><span style="color:#eb6772;">concat_ws</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39; &#39;</span><span style="color:#abb2bf;">, </span><span style="color:#eb6772;">col</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39;txt_array.case_std&#39;</span><span style="color:#abb2bf;">))) \
    .</span><span style="color:#eb6772;">drop</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&#39;txt_array&#39;</span><span style="color:#abb2bf;">)
</span></code></pre>
<p>This query was transforming token data generated by Tesseract into lines.
Beyond the aggregation operation there was also some concern that the
operation may be ran against quite large datasets depending on how much
<a href="https://github.com/tesseract-ocr">Tesseract</a> output was being manipulated
at once.</p>
<p>Outside of the raw functionality I was asked if the data could be structured
to provide an interface with named columns in a style similar to SQL rather
than having to reference positional data.</p>
<p>All of this seemed fairly straightforward. Provided with some sample data I
pulled in the UDF that was already in Python and set out to apply the
transformations first illustrating how we could interact with the data in a way
similar to SQL with pipeline transformations and named references.</p>
<h2 id="porting-transformations">Porting Transformations</h2>
<pre style="background-color:#2b303b;">
<code class="language-python" data-lang="python"><span style="color:#cd74e8;">import </span><span style="color:#abb2bf;">itertools

</span><span style="color:#cd74e8;">from </span><span style="color:#abb2bf;">csv </span><span style="color:#cd74e8;">import </span><span style="color:#abb2bf;">DictReader
</span><span style="color:#cd74e8;">from </span><span style="color:#abb2bf;">collections </span><span style="color:#cd74e8;">import </span><span style="color:#abb2bf;">namedtuple

</span><span style="color:#cd74e8;">def </span><span style="color:#5cb3fa;">case_std</span><span style="color:#abb2bf;">(</span><span style="color:#eb6772;">x</span><span style="color:#abb2bf;">):
    </span><span style="color:#cd74e8;">if </span><span style="color:#abb2bf;">x.</span><span style="color:#eb6772;">isupper</span><span style="color:#abb2bf;">():
        </span><span style="color:#cd74e8;">return </span><span style="color:#abb2bf;">x.</span><span style="color:#eb6772;">title</span><span style="color:#abb2bf;">()
    </span><span style="color:#cd74e8;">elif not </span><span style="color:#abb2bf;">x.</span><span style="color:#eb6772;">islower</span><span style="color:#abb2bf;">() </span><span style="color:#cd74e8;">and not </span><span style="color:#abb2bf;">x.</span><span style="color:#eb6772;">isupper</span><span style="color:#abb2bf;">():
        </span><span style="color:#cd74e8;">return </span><span style="color:#abb2bf;">x.</span><span style="color:#eb6772;">title</span><span style="color:#abb2bf;">()
    </span><span style="color:#cd74e8;">else</span><span style="color:#abb2bf;">:
        </span><span style="color:#cd74e8;">return </span><span style="color:#abb2bf;">x

</span><span style="color:#cd74e8;">with </span><span style="color:#5ebfcc;">open</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&quot;sampledata/export.csv&quot;</span><span style="color:#abb2bf;">) </span><span style="color:#cd74e8;">as </span><span style="color:#abb2bf;">sample:
    reader </span><span style="color:#adb7c9;">= </span><span style="color:#eb6772;">DictReader</span><span style="color:#abb2bf;">(sample)
    data </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">[row </span><span style="color:#cd74e8;">for </span><span style="color:#abb2bf;">row </span><span style="color:#cd74e8;">in </span><span style="color:#abb2bf;">reader]

a </span><span style="color:#adb7c9;">= </span><span style="color:#5ebfcc;">filter</span><span style="color:#abb2bf;">(</span><span style="color:#cd74e8;">lambda </span><span style="color:#eb6772;">x</span><span style="color:#abb2bf;">: </span><span style="color:#5ebfcc;">int</span><span style="color:#abb2bf;">(x[</span><span style="color:#9acc76;">&quot;level&quot;</span><span style="color:#abb2bf;">]) </span><span style="color:#adb7c9;">== </span><span style="color:#db9d63;">5</span><span style="color:#abb2bf;">, data)
filtered </span><span style="color:#adb7c9;">= </span><span style="color:#5ebfcc;">filter</span><span style="color:#abb2bf;">(</span><span style="color:#cd74e8;">lambda </span><span style="color:#eb6772;">x</span><span style="color:#abb2bf;">: </span><span style="color:#5ebfcc;">len</span><span style="color:#abb2bf;">(x[</span><span style="color:#9acc76;">&quot;text&quot;</span><span style="color:#abb2bf;">].</span><span style="color:#eb6772;">strip</span><span style="color:#abb2bf;">()) </span><span style="color:#adb7c9;">&gt; </span><span style="color:#db9d63;">0</span><span style="color:#abb2bf;">, a)
fixed </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">({</span><span style="color:#adb7c9;">**</span><span style="color:#abb2bf;">row, </span><span style="color:#9acc76;">&#39;text&#39;</span><span style="color:#abb2bf;">:</span><span style="color:#eb6772;">case_std</span><span style="color:#abb2bf;">(row[</span><span style="color:#9acc76;">&quot;text&quot;</span><span style="color:#abb2bf;">])} </span><span style="color:#cd74e8;">for </span><span style="color:#abb2bf;">row </span><span style="color:#cd74e8;">in </span><span style="color:#abb2bf;">filtered)

tk_pos </span><span style="color:#adb7c9;">= </span><span style="color:#eb6772;">named_tuple</span><span style="color:#abb2bf;">(</span><span style="color:#9acc76;">&quot;tk_pos&quot;</span><span style="color:#abb2bf;">, </span><span style="color:#9acc76;">&quot;word_num, text&quot;</span><span style="color:#abb2bf;">)
result </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">(</span><span style="color:#5ebfcc;">dict</span><span style="color:#abb2bf;">(row, </span><span style="color:#adb7c9;">**</span><span style="color:#abb2bf;">{</span><span style="color:#9acc76;">&quot;tk_pos&quot;</span><span style="color:#abb2bf;">:</span><span style="color:#eb6772;">tk_pos</span><span style="color:#abb2bf;">(row[</span><span style="color:#9acc76;">&quot;wrd_num&quot;</span><span style="color:#abb2bf;">], row[</span><span style="color:#9acc76;">&quot;text&quot;</span><span style="color:#abb2bf;">])}) </span><span style="color:#cd74e8;">for </span><span style="color:#abb2bf;">row </span><span style="color:#cd74e8;">in </span><span style="color:#abb2bf;">fixed)
</span></code></pre>
<p>To start I read the data in with a <a href="https://docs.python.org/3.7/library/csv.html#csv.DictReader">DictReader</a>
which allowed me to reference values by name like &quot;level&quot; and &quot;text&quot;. I then
applied similar data transformations making use of <a href="https://docs.python.org/3.7/library/functions.html#filter">filter</a>,
<a href="https://docs.python.org/3/tutorial/datastructures.html#list-comprehensions">comprehensions</a>,
and <a href="https://docs.python.org/3/reference/expressions.html">unpacking</a> to try and
keep a style similar to some PySpark operations.</p>
<p>Finally I put the rest of the transformations into a <a href="https://www.python.org/dev/peps/pep-0289/">generator expression</a>
containing a dict of <a href="https://docs.python.org/3.7/library/collections.html#collections.namedtuple">namedtuple</a>
values so that later operations could continue working on named values in a
manner similar to SQL columns.</p>
<h2 id="groupby">GROUPBY</h2>
<p>With the transformation and named values part out of the way I moved onto the
<code>GROUPBY</code> aggregations. Thinking about <code>GROUPBY</code> the goal is to apply an
aggregation function to a unique value. That unique value can be represented
multiple ways, but I wanted to show the idea behind what was happening to help
with future port efforts. So on my first pass I wrote:</p>
<pre style="background-color:#2b303b;">
<code class="language-python" data-lang="python"><span style="color:#abb2bf;">grouped </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">[]
seen </span><span style="color:#adb7c9;">= </span><span style="color:#5ebfcc;">set</span><span style="color:#abb2bf;">()

</span><span style="font-style:italic;color:#5f697a;"># Order is known because it represents data generated by tesseract
</span><span style="color:#cd74e8;">for </span><span style="color:#abb2bf;">row </span><span style="color:#cd74e8;">in </span><span style="color:#abb2bf;">fixed:
    key </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">(row[</span><span style="color:#9acc76;">&quot;page_num&quot;</span><span style="color:#abb2bf;">], row[</span><span style="color:#9acc76;">&quot;block_num&quot;</span><span style="color:#abb2bf;">], row[</span><span style="color:#9acc76;">&quot;par_num&quot;</span><span style="color:#abb2bf;">], row[</span><span style="color:#9acc76;">&quot;line_num&quot;</span><span style="color:#abb2bf;">])

    </span><span style="color:#cd74e8;">if </span><span style="color:#abb2bf;">key </span><span style="color:#cd74e8;">in </span><span style="color:#abb2bf;">seen:
        </span><span style="color:#cd74e8;">continue

    </span><span style="color:#abb2bf;">seen.</span><span style="color:#eb6772;">add</span><span style="color:#abb2bf;">(key)

    line </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">[]

    </span><span style="color:#cd74e8;">for </span><span style="color:#abb2bf;">r </span><span style="color:#cd74e8;">in </span><span style="color:#abb2bf;">fixed:
        rkey </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">(r[</span><span style="color:#9acc76;">&quot;page_num&#39;, r[&quot;</span><span style="color:#abb2bf;">block_num</span><span style="color:#9acc76;">&quot;], r[&quot;</span><span style="color:#abb2bf;">par_num</span><span style="color:#9acc76;">&quot;], r[&quot;</span><span style="color:#abb2bf;">line_num</span><span style="color:#9acc76;">&quot;])</span><span style="background-color:#e05252;color:#ffffff;">
</span><span style="color:#abb2bf;">        </span><span style="color:#cd74e8;">if </span><span style="color:#abb2bf;">key </span><span style="color:#adb7c9;">== </span><span style="color:#abb2bf;">rkey:
            line.</span><span style="color:#eb6772;">append</span><span style="color:#abb2bf;">(r[</span><span style="color:#9acc76;">&quot;c_txt&quot;</span><span style="color:#abb2bf;">])

    txt = </span><span style="color:#9acc76;">&quot; &quot;</span><span style="color:#abb2bf;">.</span><span style="color:#eb6772;">join</span><span style="color:#abb2bf;">(line)
    clean_txt = txt.</span><span style="color:#eb6772;">strip</span><span style="color:#abb2bf;">()

    </span><span style="color:#cd74e8;">if </span><span style="color:#abb2bf;">clean_txt:
        grouped.</span><span style="color:#eb6772;">append</span><span style="color:#abb2bf;">(
            {
               </span><span style="color:#9acc76;">&quot;page_num&quot;</span><span style="color:#abb2bf;">: row[</span><span style="color:#9acc76;">&quot;page_num&quot;</span><span style="color:#abb2bf;">],
               </span><span style="color:#9acc76;">&quot;block_num&quot;</span><span style="color:#abb2bf;">: row[</span><span style="color:#9acc76;">&quot;block_num&quot;</span><span style="color:#abb2bf;">],
               </span><span style="color:#9acc76;">&quot;par_num&quot;</span><span style="color:#abb2bf;">: row[</span><span style="color:#9acc76;">&quot;par_num&quot;</span><span style="color:#abb2bf;">],
               </span><span style="color:#9acc76;">&quot;ln_num&quot;</span><span style="color:#abb2bf;">: row[</span><span style="color:#9acc76;">&quot;line_num&quot;</span><span style="color:#abb2bf;">],
               </span><span style="color:#9acc76;">&quot;text&quot;</span><span style="color:#abb2bf;">: clean_txt,
            }
        )
</span></code></pre>
<p>Keeping in mind that this was to conceptualize what could be happening behind
the scenes for the <code>GROUPBY</code> and <code>AGG</code> operation here we loop over our rows
generating a hash from some values. Once we have this hash we check if we have
seen it before by referencing a <code>set</code>. If this is a new value we find all
values of the hash in our transformed data, append the tokens, handle empty
tokens and finally add the data to our final dataset. At the end we have lines
of text (instead of individual tokens) that can be referenced by page, block,
paragraph and line number.</p>
<p>While this works it's horribly inefficient. It stands out that we are
reiterating our transformed data every time we find a new key. But the goal for
this wasn't to be efficient. It was to show the ideas expressed in SQL with
Python. Specifically it was highlighting how to express a <code>GROUPBY/AGG</code>
operation manually using hashes of values and tracking what we have and have
not seen providing a final dataset that was the same as the output of the SQL
statement.</p>
<h2 id="itertools">itertools</h2>
<p>Continuing on from that point one of my favorite Python modules is <code>itertools</code>.
If you haven't spent much time with it I highly recommend taking some of your
existing code and looking over it while scanning the itertools docs. I've used
<code>islice</code>, <code>chain</code> and <code>zip_longest</code> innumberable times. Because of that I knew
there was a handy <code>groupby</code> function stowed in there too:</p>
<pre style="background-color:#2b303b;">
<code class="language-text" data-lang="text"><span style="color:#abb2bf;">Make an iterator that returns consecutive keys and groups from the iterable.
The key is a function computing a key value for each element. If not specified
or is None, key defaults to an identity function and returns the element
unchanged.

Generally, the iterable needs to already be sorted on the same key function.
</span></code></pre>
<p>Replacing the block above:</p>
<pre style="background-color:#2b303b;">
<code class="language-python" data-lang="python"><span style="color:#abb2bf;">final </span><span style="color:#adb7c9;">= </span><span style="color:#abb2bf;">[]

</span><span style="color:#cd74e8;">for </span><span style="color:#abb2bf;">key, group </span><span style="color:#cd74e8;">in </span><span style="color:#abb2bf;">itertools.</span><span style="color:#eb6772;">groupby</span><span style="color:#abb2bf;">(
    req, </span><span style="color:#eb6772;">key</span><span style="color:#adb7c9;">=</span><span style="color:#cd74e8;">lambda </span><span style="color:#eb6772;">x</span><span style="color:#abb2bf;">: (x[</span><span style="color:#9acc76;">&quot;page_num&quot;</span><span style="color:#abb2bf;">], x[</span><span style="color:#9acc76;">&quot;block_num&quot;</span><span style="color:#abb2bf;">], x[</span><span style="color:#9acc76;">&quot;par_num&quot;</span><span style="color:#abb2bf;">], x[</span><span style="color:#9acc76;">&quot;line_num&quot;</span><span style="color:#abb2bf;">])
):
    line </span><span style="color:#adb7c9;">= </span><span style="color:#9acc76;">&quot;&quot;</span><span style="color:#abb2bf;">.</span><span style="color:#eb6772;">join</span><span style="color:#abb2bf;">([row[</span><span style="color:#9acc76;">&#39;text&#39;</span><span style="color:#abb2bf;">] </span><span style="color:#adb7c9;">+ </span><span style="color:#9acc76;">&quot; &quot; </span><span style="color:#cd74e8;">for </span><span style="color:#abb2bf;">row </span><span style="color:#cd74e8;">in </span><span style="color:#abb2bf;">group])
    final.</span><span style="color:#eb6772;">append</span><span style="color:#abb2bf;">({</span><span style="color:#9acc76;">&quot;page_num&quot;</span><span style="color:#abb2bf;">: key[</span><span style="color:#db9d63;">0</span><span style="color:#abb2bf;">],
                  </span><span style="color:#9acc76;">&quot;block_num&quot;</span><span style="color:#abb2bf;">: key[</span><span style="color:#db9d63;">1</span><span style="color:#abb2bf;">],
                  </span><span style="color:#9acc76;">&quot;par_num&quot;</span><span style="color:#abb2bf;">: key[</span><span style="color:#db9d63;">2</span><span style="color:#abb2bf;">],
                  </span><span style="color:#9acc76;">&quot;line_num&quot;</span><span style="color:#abb2bf;">: key[</span><span style="color:#db9d63;">3</span><span style="color:#abb2bf;">],
                  </span><span style="color:#9acc76;">&quot;text&quot;</span><span style="color:#abb2bf;">: line,
                })
</span></code></pre>
<p>And with that change we have a clean, faster implementation. Additionally since
this was a port of Spark SQL if the data was to get truly large it wouldn't be
much work to start iterating through all of the pipeline in batches since we
can use generators all the way through.</p>
<h2 id="conclusion">Conclusion</h2>
<p>So what was the point of sharing that here? Nothing specific. It was a fun
exercise at the time, and it made me pause to consider how I would express
<code>GROUPBY</code> on my own. The exercise also helped introduce some of my colleagues
to the <code>filter</code> expression and in turn <code>map</code> and <code>reduce</code>. Using those they
were able to express a lot of their pipeline concepts without a lot of the
iteration structures they were used to having abstracted away. If you find
yourself doing a lot of pipelining I recommend checking out <code>itertools</code> and
<code>functools</code>. Both are built into the Python stdlib and provide a lot of helpful
functionality.</p>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="field">
        <p class="control has-icons-right">
          <input class="input" id="search" placeholder="Search this website." type="search" />
          <span class="icon is-small is-right">
            <i class="fas fa-search"></i>
          </span>
        </p>
      </div>
      <div class="search-results">
        <div class="search-results__items"></div>
      </div>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


   
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
          
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;resharper-global-tools&#x2F;"
            >
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              Getting started with Resharper Global Tools
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;train-all-the-things-dependencies-and-bugs&#x2F;"
            >
              Train All the Things - Speed Bumps<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
            
        </nav>
      </div>
    </div>
  </div>
</section>
 

    

  
  <footer class="py-4 has-background-light">
    <p class="has-text-centered">
      Built with
      <span class="icon is-small">
        <i class="fas fa-code fa-xs"></i>
      </span>
      code and
      <span class="icon is-small">
        <i class="fas fa-heart fa-xs"></i>
      </span>
      love <br /> Powered By
      <span class="icon is-small">
        <i class="fas fa-power-off fa-xs"></i>
      </span>
      Zola <br />Posts licensed by <a href="https://creativecommons.org/publicdomain/zero/1.0/">Creative Commons CC0 1.0 </a><i class="fa fa-cc"></i>
      <br /> Code licensed <a href="https://www.gnu.org/licenses/lgpl-3.0.txt">LGPL</a>
    </p>
  </footer>
  

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sharer.js@latest/sharer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/galleria.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1/dist/chart.xkcd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/elasticlunr/0.9.6/elasticlunr.min.js"></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;search_index.en.js'></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;js&#x2F;site.js'></script>

    
</body>

</html>