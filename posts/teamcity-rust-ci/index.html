<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.css"
    rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
  <link href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;site.css' rel="stylesheet" />

  
  

  <title>
     burningdaylight | Setting up a CI pipeline for Rust in Teamcity 
  </title>

  <script crossorigin="anonymous" src="https://kit.fontawesome.com/201b8d5e05.js"></script>

  
</head>

<body class="has-background-white">
  
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item has-text-weight-bold" href="/">burningdaylight</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;'>
            Home
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts'>
            Posts
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;docs'>
            Docs
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;github.com&#x2F;n0mn0m'>
            Repos
          </a>
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>
  

  
  

  
<section class="section pb-0">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article>
          <h1 class="title">Setting up a CI pipeline for Rust in Teamcity</h1>
          <h2 class="subtitle"></h2>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="fas fa-user"></i>
    </span>
     published on
    <span class="icon">
      <i class="far fa-calendar-alt"></i>
    </span>
    <time datetime='2021-02-10'>February 10, 2021</time>
  </p>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="far fa-clock"></i>
    </span>
    4 min,
    <span class="icon">
      <i class="fas fa-pencil-alt"></i>
    </span>
    602 words
  </p>

            </div>
            <div class="column is-4">
              
            </div>
            <div class="column is-8 has-text-right-desktop">
               
  <p>
    <span class="has-text-black has-text-weight-normal">Tags:</span>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;rust&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        rust
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;ci&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        ci
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;pipeline&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        pipeline
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;jetbrains&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        jetbrains
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;teamcity&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        teamcity
      </a>
    
  </p>
 
            </div>
          </div>
          <div class="content has-text-justified">
            <p>Towards the end of last year I started working on a <a href="https://github.com/n0mn0m/artemis/">project</a>
in rust that would listen to a message queue and send an email. Additionally it
used <a href="https://rocket.rs/">rocket</a> to expose some diagnostic endpoints to check
on the health of the service, change log levels, etc. When starting new projects
I default to setting up a build pipeline for them to. For this project I setup
pipelines in teamcity which was overall pretty easy, but sharing here for anybody
else that may go down this path.</p>
<h2 id="cargo-make"><a href="https://github.com/sagiegurari/cargo-make">cargo-make</a></h2>
<p>For new projects I like to capture the build, admin and CI steps in a way that makes
it convenient for others to run on their local machine. Make and it's derivatives
(cmake, cake, etc) provide a useful task abstraction and Rust has the powerful
<a href="https://github.com/sagiegurari/cargo-make">cargo-make</a> project that lets us capture
task and mix together inline simple commands with scripts, dependencies etc.</p>
<p>For this project you can find my cargo make file <a href="https://github.com/n0mn0m/artemis/tree/Makefile.toml">here</a>.
I also experimented with using Powershell for my <a href="https://github.com/n0mn0m/artemis/tree/tools">scripts/wrappers</a>.
I've been using this in my day job where our projects run on Win, macOS and Linux.
Overall I'm pretty happy with the experience, but it is another tool to install and
maintain along with various platforms missing support.</p>
<h2 id="cargo-test">cargo test</h2>
<p>Rust comes with a build tool and test runner built in via cargo. Running test
is easy out of the box, but I needed to make use of a couple tools to get the
cargo test output into a format that a CI tool parses. I ended getting test and
coverage data in the junit and lcov formats that way various tools and platforms
can be used across time and projects.</p>
<ul>
<li><a href="https://github.com/mozilla/grcov">grcov</a></li>
<li><a href="https://github.com/johnterickson/cargo2junit">cargo2junit</a></li>
</ul>
<h2 id="teamcity">Teamcity</h2>
<p>With those tools orchestrated via <code>cargo make</code> it's time to setup the build and
test steps in Teamcity. Overall the process was pretty easy, but I ran into a couple
bumps I'll highlight.</p>
<ul>
<li>The <code>cargo</code> step doesn't support custom commands, so I don't use that by default
<ul>
<li>I wrote <a href="https://github.com/n0mn0m/artemis/tree/tools/CI.ps1">CI.ps1</a>
as a wrapper to use in each <a href="https://github.com/n0mn0m/artemis/tree/.teamcity/settings.kts#n88">step</a>.</li>
</ul>
</li>
<li>Enable the <a href="https://github.com/n0mn0m/artemis/tree/.teamcity/settings.kts#n186">xml-report-plugin</a></li>
</ul>
<p>And with those two things the <a href="https://github.com/n0mn0m/artemis/tree/.teamcity/settings.kts">pipeline</a>
is ready to <a href="https://teamcity.burningdaylight.io/">go</a>. From there you may want
to add your own environment variables, plugin, agent deps etc.</p>
<h2 id="next-steps">Next steps</h2>
<p>With this pipeline up an running the next steps are:</p>
<ul>
<li>Setup build caching with something like <a href="https://github.com/mozilla/sccache">sccache</a></li>
<li>Work on local and CI build times
<ul>
<li>This has been <a href="https://endler.dev/2020/rust-compile-times/">written</a> about
a <a href="https://blog.mozilla.org/nnethercote/2020/04/24/how-to-speed-up-the-rust-compiler-in-2020/">number</a>
of <a href="https://pingcap.com/blog/rust-compilation-model-calamity">times</a></li>
</ul>
</li>
</ul>
<p>I would need to make both of these better before taking the project further. As
the project grows these would only get worse, and make the project unpleasant for
others to work on.</p>
<h2 id="done">Done</h2>
<p>That's it for now. I learned a lot along the way about Rust, cargo, and hooking
it up with Teamcity. I'm not sure I'll have a write up on artemis anytime soon.
It was a good project, but I ultimately took another path. Hopefully this helps
somebody, and as always feel free to <a href="mailto:alexander@burningdaylight.io">reach out</a>.</p>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="field">
        <p class="control has-icons-right">
          <input class="input" id="search" placeholder="Search this website." type="search" />
          <span class="icon is-small is-right">
            <i class="fas fa-search"></i>
          </span>
        </p>
      </div>
      <div class="search-results">
        <div class="search-results__items"></div>
      </div>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


   
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
          
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;using-good-defaults&#x2F;"
            >
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              Finding good defaults
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;joy-of-repair&#x2F;"
            >
              The joy of repair<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
            
        </nav>
      </div>
    </div>
  </div>
</section>
 

    

  
  <footer class="py-4 has-background-light">
    <p class="has-text-centered">
      Built with
      <span class="icon is-small">
        <i class="fas fa-code fa-xs"></i>
      </span>
      code and
      <span class="icon is-small">
        <i class="fas fa-heart fa-xs"></i>
      </span>
      love <br /> Powered By
      <span class="icon is-small">
        <i class="fas fa-power-off fa-xs"></i>
      </span>
      Zola <br />Posts licensed by <a href="https://creativecommons.org/publicdomain/zero/1.0/">Creative Commons CC0 1.0 </a><i class="fa fa-cc"></i>
      <br /> Code licensed <a href="https://www.gnu.org/licenses/lgpl-3.0.txt">LGPL</a>
    </p>
  </footer>
  

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sharer.js@latest/sharer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/galleria.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1/dist/chart.xkcd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/elasticlunr/0.9.6/elasticlunr.min.js"></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;search_index.en.js'></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;js&#x2F;site.js'></script>

    
</body>

</html>