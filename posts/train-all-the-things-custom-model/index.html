<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  <link href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.css"
    rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
  <link href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;site.css' rel="stylesheet" />

  
  

  <title>
     burningdaylight | Train All the Things - Model Training 
  </title>

  <script crossorigin="anonymous" src="https://kit.fontawesome.com/201b8d5e05.js"></script>

  
</head>

<body class="has-background-white">
  
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item has-text-weight-bold" href="/">burningdaylight</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;'>
            Home
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts'>
            Posts
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;docs'>
            Docs
          </a>
          
          <a class="navbar-item" href='https:&#x2F;&#x2F;github.com&#x2F;n0mn0m'>
            Repos
          </a>
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>
  

  
  

  
<section class="section pb-0">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article>
          <h1 class="title">Train All the Things - Model Training</h1>
          <h2 class="subtitle"></h2>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="fas fa-user"></i>
    </span>
     published on
    <span class="icon">
      <i class="far fa-calendar-alt"></i>
    </span>
    <time datetime='2020-03-24'>March 24, 2020</time>
  </p>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
  <p class="has-text-grey">
    <span class="icon">
      <i class="far fa-clock"></i>
    </span>
    4 min,
    <span class="icon">
      <i class="fas fa-pencil-alt"></i>
    </span>
    781 words
  </p>

            </div>
            <div class="column is-4">
              
            </div>
            <div class="column is-8 has-text-right-desktop">
               
  <p>
    <span class="has-text-black has-text-weight-normal">Tags:</span>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;hackaday&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        hackaday
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;maker&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        maker
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;machine-learning&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        machine learning
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;training&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        training
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;train-all-the-things&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        train all the things
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;tensorflow&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        tensorflow
      </a>
    
      <a class="link has-text-weight-light" href='https:&#x2F;&#x2F;burningdaylight.io&#x2F;tags&#x2F;esp&#x2F;'>
        <span class="icon is-small">
          <i class="fas fa-tag fa-xs"></i>
        </span>
        esp
      </a>
    
  </p>
 
            </div>
          </div>
          <div class="content has-text-justified">
            <p>Recently I spent some time learning how to generate synthetic voices using
<a href="https://burningdaylight.io/posts/train-all-the-things-data-generation/">espeak</a>. After working with the
tools to aligning with the Tensorflow keyword models expectations I was ready
for training, and to see how well the synthetic data performed. TLDR: not well
:)</p>
<p>I started by training using the keywords <code>hi</code>, <code>smalltalk</code> and <code>on</code>. This let me
have a known working word while testing two synthetic words. Although training
went well:</p>
<pre style="background-color:#2b303b;">
<code class="language-text" data-lang="text"><span style="color:#abb2bf;">INFO:tensorflow:Saving to &quot;/Users/n0mn0m/projects/on-air/voice-assistant/train/model/speech_commands_train/tiny_conv.ckpt-18000&quot;
I0330 10:34:28.514455 4629171648 train.py:297] Saving to &quot;/Users/n0mn0m/projects/on-air/voice-assistant/train/model/speech_commands_train/tiny_conv.ckpt-18000&quot;
INFO:tensorflow:set_size=1445
I0330 10:34:28.570324 4629171648 train.py:301] set_size=1445
WARNING:tensorflow:Confusion Matrix:
 [[231   3   3   0   4]
 [  2 178   6  29  26]
 [  3  12 146   2   2]
 [  4  17   2 352  21]
 [  2  16   7  16 361]]
W0330 10:34:32.116044 4629171648 train.py:320] Confusion Matrix:
 [[231   3   3   0   4]
 [  2 178   6  29  26]
 [  3  12 146   2   2]
 [  4  17   2 352  21]
 [  2  16   7  16 361]]
WARNING:tensorflow:Final test accuracy = 87.8% (N=1445)
W0330 10:34:32.116887 4629171648 train.py:322] Final test accuracy = 87.8% (N=1445)
</span></code></pre>
<p>The model didn't respond well once it was loaded onto the ESP-EYE. I tried a
couple more rounds with other keywords and spectrogram samples with similar
results.</p>
<p>Because of the brute force nature that I used to generate audio the synthetic
training data isn't very representative of real human voices. While the
experiment didn't work out, I do think that generating data this way could be
useful with the right amount of time and research. Instead of scaling parameters
in a loop I think researching the characteristic of various human voices and
using those to tune the data generated via espeak could actually work out well.
That said it's possible the model may pick up on characteristics of the espeak
program too. Regardless, voice data that is ready for training is still a hard
problem in need of more open solutions.</p>
<p>Along with the way I scaled the espeak parameters another monkey wrench is that
the microspeech model makes use of a CNN and spectrogram of the input audio
instead of full signal processing. This means it's highly likely the model will
work with voices around the comparison spectrogram well, but not generalize.
This makes picking the right spectrogram relative to the user another key task.</p>
<p>Because of these results and bigger issues I ended up tweaking my approach and
used
<a href="https://github.com/n0mn0m/on-air/tree/main/voice-assistant/smalltalk/main/main_functions.cc"><code>visual</code></a>
as my wake word followed by on/off. All of these are available in the TF command
words dataset, and visual seems like an ok wake word when controlling a display.
For somebody working on a generic voice assistant you will want to work on audio
segmentation since many datasets are sentences, or consider using something like
<a href="https://github.com/espressif/esp-skainet">Skainet</a>. All of this was less fun
than running my own model from synthtetic data, but I needed to continue
forward. After a final round of training with all three words I followed the TF
<a href="https://www.tensorflow.org/lite/microcontrollers?hl=he">docs</a> to represent the
model as a C array and then flashed it onto the board with the rest of the
program. Using <code>idf monitor</code> I was able to observe the model working as
expected:</p>
<pre style="background-color:#2b303b;">
<code class="language-text" data-lang="text"><span style="color:#abb2bf;">I (31) boot: ESP-IDF v4.1
I (31) boot: compile time 13:35:43
I (704) wifi: config NVS flash: enabled
I (734) WIFI STATION: Setting WiFi configuration SSID Hallow...
I (824) WIFI STATION: wifi_init_sta finished.
I (1014) TF_LITE_AUDIO_PROVIDER: Audio Recording started
Waking up
Recognized on
I (20434) HTTPS_HANDLING: HTTPS Status = 200, content_length = 1
I (20434) HTTPS_HANDLING: HTTP_EVENT_DISCONNECTED
I (20444) HTTPS_HANDLING: HTTP_EVENT_DISCONNECTED
Going back to sleep.
Waking up
Recognized off
I (45624) HTTPS_HANDLING: HTTPS Status = 200, content_length = 1
I (45624) HTTPS_HANDLING: HTTP_EVENT_DISCONNECTED
I (45634) HTTPS_HANDLING: HTTP_EVENT_DISCONNECTED
</span></code></pre>
<p>This was an educational experiment. It helped me put some new tools in my belt
while thinking further about the problem of voice and audio processing. I
developed some
<a href="https://github.com/n0mn0m/on-air/tree/main/voice-assistant/train">scripts</a> to
run through the full data generation, train and export cycle. Training will need
to be done based on the architecture somebody is using, but hopefully it's
useful.</p>
<p>The code, docs, images etc for the project can be found
<a href="https://github.com/n0mn0m/on-air">here</a> and I'll be posting updates as I
continue along to <a href="https://hackaday.io/project/170228-on-air">HackadayIO</a> and
this blog. If you have any questions or ideas reach
<a href="mailto:n0mn0m@burningdaylight.io">out</a>.</p>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <div class="field">
        <p class="control has-icons-right">
          <input class="input" id="search" placeholder="Search this website." type="search" />
          <span class="icon is-small is-right">
            <i class="fas fa-search"></i>
          </span>
        </p>
      </div>
      <div class="search-results">
        <div class="search-results__items"></div>
      </div>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


   
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
          
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;train-all-the-things-v01&#x2F;"
            >
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              Train All the Things - Version 0.1
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a
              class="button is-black is-outlined"
              href="https:&#x2F;&#x2F;burningdaylight.io&#x2F;posts&#x2F;train-all-the-things-data-generation&#x2F;"
            >
              Train All the Things - Synthetic Generation<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
            
        </nav>
      </div>
    </div>
  </div>
</section>
 

    

  
  <footer class="py-4 has-background-light">
    <p class="has-text-centered">
      Built with
      <span class="icon is-small">
        <i class="fas fa-code fa-xs"></i>
      </span>
      code and
      <span class="icon is-small">
        <i class="fas fa-heart fa-xs"></i>
      </span>
      love <br /> Powered By
      <span class="icon is-small">
        <i class="fas fa-power-off fa-xs"></i>
      </span>
      Zola <br />Posts licensed by <a href="https://creativecommons.org/publicdomain/zero/1.0/">Creative Commons CC0 1.0 </a><i class="fa fa-cc"></i>
      <br /> Code licensed <a href="https://www.gnu.org/licenses/lgpl-3.0.txt">LGPL</a>
    </p>
  </footer>
  

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sharer.js@latest/sharer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/galleria.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1/dist/chart.xkcd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.6.1/themes/folio/galleria.folio.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/elasticlunr/0.9.6/elasticlunr.min.js"></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;search_index.en.js'></script>
  <script src='https:&#x2F;&#x2F;burningdaylight.io&#x2F;js&#x2F;site.js'></script>

    
</body>

</html>